#https://github.com/cocaman/malware-bazaar/blob/master/bazaar_download.py

import argparse
import csv
import requests
import concurrent.futures

csv_path = '../sha256/'
malware_path = '../../DataSet/malware/'

sha256 = []

def read_csv(csvName):
    with open(csv_path + csvName, mode='r')as file:
        csvFile = csv.reader(file)
        for line in csvFile:
            sha256.append(line)

def check_sha256(s):
    if s == "":
        return False
    if len(s) != 64:
        print(f"Please use sha256 value instead of '{s}'")
        return False
    return True

def download_file(hash):
    data = {
        'query': 'get_file',
        'sha256_hash': hash,
    }

    try:
        response = requests.post('https://mb-api.abuse.ch/api/v1/', data=data, allow_redirects=True)
    except requests.Timeout:
        print('ERROR: timed out downloading following file:')
        print(hash)
        with open('/home/wj/DataSet/download_error.log', 'w') as f:
            f.write(f'"{hash}"\n')

    if 'file_not_found' in response.text:
        print(f"Error: couldn't find {hash}")
        return
    if 'error' in response.text:
        print(f'ERROR: {response.text}')
        return
    else:
        open(malware_path + hash + '.zip', 'wb').write(response.content)
    print(f"Sample {hash} downloaded.")

parser = argparse.ArgumentParser(description='Download a list of malware samples from Malware Bazaar by abuse.ch')
parser.add_argument('-s', '--csv', help='path to csv file with sha256-hashes of malware to be downloaded', required=True)

read_csv(parser.parse_args().csv)
valid_sha256 = [key[0] for key in sha256 if check_sha256(key[0])]

with concurrent.futures.ThreadPoolExecutor() as executor:
    futures = [executor.submit(download_file, hash) for hash in valid_sha256]
    for future in concurrent.futures.as_completed(futures):
        print(future.result())

print('done')
